#include <Adafruit_Fingerprint.h>
#include <HardwareSerial.h>
#include <FS.h>
#include <SPIFFS.h>

HardwareSerial mySerial(1);
Adafruit_Fingerprint finger = Adafruit_Fingerprint(&mySerial);

uint8_t id;

void setup() {
  Serial.begin(115200);
  delay(1000);

  // Inicializuj SPIFFS
  if (!SPIFFS.begin(true)) {
    Serial.println("‚ùå Chyba pri sp√∫≈°≈•an√≠ SPIFFS");
    return;
  }

  mySerial.begin(57600, SERIAL_8N1, 16, 17);
  Serial.println("üîç Hƒæad√°m fingerprint senzor...");
  finger.begin(57600);

  if (finger.verifyPassword()) {
    Serial.println("‚úÖ Senzor n√°jden√Ω!");
  } else {
    Serial.println("‚ùå Senzor sa nena≈°iel :(");
    while (1);
  }

  finger.getParameters();
}

void loop() {
  Serial.println("Zadaj ID (1‚Äì127), pod ktor√Ωm chce≈° ulo≈æi≈• odtlaƒçok:");
  while (!Serial.available());
  id = Serial.parseInt();
  Serial.read();  // Vyƒçisti serial buffer

  if (id == 0 || id > 127) {
    Serial.println("‚ùå Neplatn√© ID!");
    return;
  }

  Serial.println("Zadaj meno a priezvisko:");
  String meno = "";
  while (meno.length() < 1) {
    while (Serial.available()) {
      meno = Serial.readStringUntil('\n');
      meno.trim();
    }
  }

  if (getFingerprintEnroll() == FINGERPRINT_OK) {
    saveNameToFile(id, meno);
  }
}

void saveNameToFile(uint8_t id, String meno) {
  File file = SPIFFS.open("/users.txt", FILE_APPEND);
  if (!file) {
    Serial.println("‚ùå Nepodarilo sa otvori≈• s√∫bor na z√°pis");
    return;
  }

  file.printf("%d:%s\n", id, meno.c_str());
  file.close();
  Serial.println("‚úÖ Meno ulo≈æen√©!");
}

uint8_t getFingerprintEnroll() {
  int p = -1;
  Serial.println("üëâ Prilo≈æ prst...");
  while (p != FINGERPRINT_OK) {
    p = finger.getImage();
    if (p == FINGERPRINT_NOFINGER) continue;
    if (p == FINGERPRINT_OK) Serial.println("üì∏ Odtlaƒçok zachyten√Ω!");
    else Serial.println("‚ö†Ô∏è Chyba pri skenovan√≠.");
  }

  p = finger.image2Tz(1);
  if (p != FINGERPRINT_OK) return p;

  Serial.println("‚úã Odstr√°≈à prst...");
  delay(2000);
  while (finger.getImage() != FINGERPRINT_NOFINGER);

  Serial.println("üëâ Znovu prilo≈æ rovnak√Ω prst...");
  p = -1;
  while (p != FINGERPRINT_OK) {
    p = finger.getImage();
    if (p == FINGERPRINT_NOFINGER) continue;
    if (p == FINGERPRINT_OK) Serial.println("üì∏ Znovu zachyten√Ω!");
  }

  p = finger.image2Tz(2);
  if (p != FINGERPRINT_OK) return p;

  p = finger.createModel();
  if (p != FINGERPRINT_OK) return p;

  p = finger.storeModel(id);
  if (p == FINGERPRINT_OK) Serial.println("‚úÖ Odtlaƒçok ulo≈æen√Ω!");
  else Serial.println("‚ùå Nepodarilo sa ulo≈æi≈• odtlaƒçok.");

  return p;
}
